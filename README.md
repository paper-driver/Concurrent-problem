# [RBC Coding Interview] Concurrent Problem
## How to Run
Execute
``java -jar -Dspring.profiles.active=dev target/concurrent-0.0.1-SNAPSHOT.jar`` from the root directory of project.

## Architecture
This server is using Spring Async and Spring Transition to manage the concurrency and batch operations.

### Spring Async
This is used to create multiple threads. Currently, this server creates 10 threads.

### Spring Transition
This is used to make sure no more than one user to update or insert the same data to the database at
the same time. Optimistic Locking is applied to avoid having race conditions.

### EndPoints
#### POST /api/index/upload
Upload Dow Jones Index CSV file to database. This is insert operation and it will not update any existing rows.
One can upload multiple CSV files in one request, and the server will create multiple threads to process them concurrently.
The actual insert will be executed as batch operations.
The request will return list of HttpStatus and corresponding custom message. The example RESTful call can be found from Appendix.

#### GET /api/index/getbystock?stock=[Stock Symbol]
Find all indexes regarding a specific stock from the database. Stock Symbol has to match one of the enums 
defined in ``StockSymbol.java``. The request will return list of indexes in JSON format

#### POST /api/index/update
Update Dow Jones Index in the database. If there is no such data, the server will insert one to the database.
One can only update one row per request. The request will return HttpStatus.

### Database
This server is not in a production state. Thus, it uses an in-memory H2 database. One can access the database
from a web browser from ``http://localhost:8080/h2-console``. JDBC URL is ``jdbc:h2:mem:testdb``. There is no password for 
the database.

### ConcurrentRunner.java [i.e. CommandLineRunner]
This class will be executed right after the server started. It contains three demonstrations of concurrency/
1.  Update data: Execute 3 update calls simultaneously 
2. Get Stock: Execute 10 get calls about the stock AA simultaneously
3. Upload files: Execute 3 insert calls simultaneously. 

## Appendix
### RESTful Request Samples
You can get the request sample file in ``resources`` folder. You can import the file directory to [Postman](https://www.postman.com/).
```JSON
{
	"info": {
		"_postman_id": "18193df7-ed90-4c73-aa4d-beb4c22102c3",
		"name": "[RBC Interview] Concurrent",
		"schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
	},
	"item": [
		{
			"name": "Upload File",
			"request": {
				"method": "POST",
				"header": [
					{
						"key": "Content-Type",
						"value": "multipart\\form-data",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "files",
							"type": "file",
							"src": "/C:/Users/mukno/Documents/Projects/[RBCInterview]-cocurrent-server/data/dow_jones_index-remaining.csv"
						},
						{
							"key": "files",
							"type": "file",
							"src": [],
							"disabled": true
						},
						{
							"key": "files",
							"type": "file",
							"src": [],
							"disabled": true
						},
						{
							"key": "files",
							"type": "file",
							"src": [],
							"disabled": true
						}
					]
				},
				"url": {
					"raw": "http://localhost:8080/api/index/upload",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "8080",
					"path": [
						"api",
						"index",
						"upload"
					],
					"query": [
						{
							"key": "",
							"value": "",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Update a index",
			"request": {
				"method": "POST",
				"header": [
					{
						"warning": "This is a duplicate header and will be overridden by the Content-Type header generated by Postman.",
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "raw",
					"raw": "{\r\n        \"quarter\": 1,\r\n        \"stock\": \"AA\",\r\n        \"date\": \"2011-04-02\",\r\n        \"open\": 16.18,\r\n        \"high\": 17.39,\r\n        \"low\": 16.18,\r\n        \"close\": 17.14,\r\n        \"volume\": 154387761,\r\n        \"percent_change_price\": 5.93325,\r\n        \"percent_change_volume_over_last_wek\": 1.987451735,\r\n        \"previous_weeks_volume\": 151379173,\r\n        \"next_weeks_open\": 17.33,\r\n        \"next_weeks_close\": 17.37,\r\n        \"percent_change_next_weeks_price\": 0.230814,\r\n        \"percent_return_next_dividend\": 97.0\r\n    }"
				},
				"url": {
					"raw": "http://localhost:8080/api/index/update",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "8080",
					"path": [
						"api",
						"index",
						"update"
					],
					"query": [
						{
							"key": "",
							"value": "",
							"disabled": true
						}
					]
				}
			},
			"response": []
		},
		{
			"name": "Get By Stock",
			"protocolProfileBehavior": {
				"disableBodyPruning": true
			},
			"request": {
				"method": "GET",
				"header": [
					{
						"key": "Content-Type",
						"value": "application/json",
						"type": "text"
					}
				],
				"body": {
					"mode": "formdata",
					"formdata": [
						{
							"key": "files",
							"value": "",
							"type": "text",
							"disabled": true
						}
					]
				},
				"url": {
					"raw": "http://localhost:8080/api/index/getbystock?stock=AA",
					"protocol": "http",
					"host": [
						"localhost"
					],
					"port": "8080",
					"path": [
						"api",
						"index",
						"getbystock"
					],
					"query": [
						{
							"key": "stock",
							"value": "AA"
						}
					]
				}
			},
			"response": []
		}
	],
	"protocolProfileBehavior": {}
}
```